<!DOCTYPE html>
<html>
<head lang="en">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta charset="UTF-8">
    <title>demo</title>
</head>
<link href="demo.css" type="text/css" rel="stylesheet">
<body>
<div id="screen">
    <div class="top-btn" onclick="scrollTops()">top</div>
    <div id="mainwarpper">
        <div class="mainscroll">
            <div class="menu">
                <ul>
                    <li>首页</li>
                    <li>服饰</li>
                    <li>男士</li>
                    <li>母婴</li>
                    <li>美妆</li>
                    <li>居家</li>
                    <li>手表配饰</li>
                    <li>唯品国际</li>
                    <li>爱丽奢</li>
                    <li>唯品金融</li>
                    <li>汽车</li>
                    <li>旅游</li>
                </ul>
            </div>
            <div class="content">
                <div id="nav">
                    <ul class="hbtn">
                        <li>三</li>
                        <li>摩登奶爸
                            <select>
                                <option>广东</option>
                                <option>重庆</option>
                                <option>四川</option>
                            </select>
                        </li>
                        <li>
                            GO
                        </li>
                    </ul>
                    <ul>
                        <li>
                            <a class="active" href="javascript:" title="首页" rel="1"><span
                                    class="text">首页</span></a>
                        </li>
                        <li>
                            <a href="javascript:" title="美妆护肤" rel="2"><span
                                    class="text">美妆护肤</span></a>
                        </li>
                        <li>
                            <a href="javascript:" title="欧洲药妆" rel="3"><span
                                    class="text">欧洲药妆</span></a>
                        </li>
                        <li>
                            <a href="javascript:" title="健康保健" rel="4"><span
                                    class="text">健康保健</span></a>
                        </li>
                        <li>
                            <a href="javascript:" title="国际母婴" rel="5"><span
                                    class="text">国际母婴</span></a>
                        </li>
                    </ul>
                </div>

                <div id="pagewrapper">
                    <div id="pageflip">
                        <div class="scrollerwrapper">
                            <ul>
                                <li>
                                    菜单1第1页
                                </li>
                                <li>
                                    菜单1第1页
                                </li>
                                <li>
                                    菜单1第1页
                                </li>
                                <li>
                                    菜单1第1页
                                </li>
                                <li>
                                    菜单1第1页
                                </li>
                                <li>
                                    菜单1第1页
                                </li>
                                <li>
                                    菜单1第1页
                                </li>
                                <li>
                                    菜单1第1页
                                </li>
                                <li>
                                    菜单1第1页
                                </li>
                                <li>
                                    菜单1第1页
                                </li>
                                <li>
                                    菜单1第1页
                                </li>
                            </ul>
                        </div>
                        <div class="scrollerwrapper">
                            <ul>
                                <li>
                                    菜单2第1页
                                </li>
                                <li>
                                    菜单2第1页
                                </li>
                                <li>
                                    菜单2第1页
                                </li>
                                <li>
                                    菜单2第1页
                                </li>
                                <li>
                                    菜单2第1页
                                </li>
                                <li>
                                    菜单2第1页
                                </li>
                                <li>
                                    菜单2第1页
                                </li>
                                <li>
                                    菜单2第1页
                                </li>
                                <li>
                                    菜单2第1页
                                </li>
                                <li>
                                    菜单2第1页
                                </li>
                                <li>
                                    菜单2第1页
                                </li>
                            </ul>
                        </div>
                        <div class="scrollerwrapper">
                            <ul>
                                <li>
                                    菜单3第1页
                                </li>
                                <li>
                                    菜单3第1页
                                </li>
                                <li>
                                    菜单3第1页
                                </li>
                                <li>
                                    菜单3第1页
                                </li>
                                <li>
                                    菜单3第1页
                                </li>
                                <li>
                                    菜单3第1页
                                </li>
                                <li>
                                    菜单3第1页
                                </li>
                                <li>
                                    菜单3第1页
                                </li>
                                <li>
                                    菜单3第1页
                                </li>
                                <li>
                                    菜单3第1页
                                </li>
                                <li>
                                    菜单3第1页
                                </li>
                            </ul>
                        </div>
                        <div class="scrollerwrapper">
                            <ul>
                                <li>
                                    菜单4第1页
                                </li>
                                <li>
                                    菜单4第1页
                                </li>
                                <li>
                                    菜单4第1页
                                </li>
                                <li>
                                    菜单4第1页
                                </li>
                                <li>
                                    菜单4第1页
                                </li>
                                <li>
                                    菜单4第1页
                                </li>
                                <li>
                                    菜单4第1页
                                </li>
                                <li>
                                    菜单4第1页
                                </li>
                                <li>
                                    菜单4第1页
                                </li>
                                <li>
                                    菜单4第1页
                                </li>
                                <li>
                                    菜单4第1页
                                </li>
                            </ul>
                        </div>
                        <div class="scrollerwrapper">
                            <ul>
                                <li>
                                    菜单5第1页
                                </li>
                                <li>
                                    菜单5第1页
                                </li>
                                <li>
                                    菜单5第1页
                                </li>
                                <li>
                                    菜单5第1页
                                </li>
                                <li>
                                    菜单5第1页
                                </li>
                                <li>
                                    菜单5第1页
                                </li>
                                <li>
                                    菜单5第1页
                                </li>
                                <li>
                                    菜单5第1页
                                </li>
                                <li>
                                    菜单5第1页
                                </li>
                                <li>
                                    菜单5第1页
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="footer">
        <ul class="b-nav">
            <li>
                <a href="../index/index.html" data-transition="slide-in">
                    <div class="myIcon">
                    <span class="icon1">
                        <img src="../images/tabBar/f1.png" alt="">
                    </span>
                    </div>
                </a>
            </li>
            <li>
                <a href="../tipgoods/tipgoodslist.html" data-transition="slide-in">
                    <div class="myIcon">
                    <span class="icon2">
                        <img src="../images/tabBar/f2.png" alt="">
                    </span>
                    </div>
                </a>
            </li>
            <li>
                <a href="../user/mycar.html" data-transition="slide-in">
                    <div class="myIcon">
                    <span class="icon4">
                        <img src="../images/tabBar/f3.png" alt="">
                    </span>
                    </div>
                </a>
            </li>
            <li>
                <a href="../user/user_center.html" data-transition="slide-in">
                    <div class="myIcon">
                    <span class="icon5">
                        <img src="../images/tabBar/f4.png" alt="">
                    </span>
                    </div>
                </a>
            </li>
        </ul>
    </div>
</div>
<script src="../js/zepto.js"></script>
<script src="../js/iscroll.js"></script>
<script>
    //v基本参数定义
    var mainScroll,
            pages,
            t,
            p,
            downfresh = false ,
            page_flip,
            vertical_scroll = [],
            menuBtn = $($(".hbtn").children("li")[0]),
            menuPageNum = [],
            currentPageX = 0,
            iDevice = (/iphone|ipad/gi).test(navigator.appVersion),
            $id = function (id) {
                return document.getElementById(id);
            }, $sa = function (s) {
                return document.querySelectorAll(s);
            }, $s = function (s) {
                return document.querySelector(s);
            }, initScroll = function () {//初始化iscroll
                if (window.scrollY === 0) {
                    window.scrollY = 1;
                    t = setTimeout(initScroll, 100);
                } else {
                    clearTimeout(t);
                    t = null;
                    //获取上下滚动的iscroll
                    pages = $sa('.scrollerwrapper');

                    //设置最外层scroll
                    mainScroll = new iScroll('mainwarpper', {
                        bounce: false,
                        hScrollbar: false,
                        vScrollbar: false,
                        vScroll: false,
                        snap: true,//此处必须为true
                        momentum: false,
                        lockDirection: true,
                        fixedScrollbar: false,//只有按住屏幕的时候才能显示出滚动条
                        onScrollEnd: function () {
                            //避免在首尾页面重复请求
                            if (this.currPageX === 0) {
                                menuBtn.mark = 1;
                                page_flip.disable();
//                                console.log("**")
                            } else {
                                menuBtn.mark = 0;
                                setTimeout(function () {
                                    page_flip.enable();
                                }, 10)
                            }
                            this.refresh();
                        }
                    });

                    //设置左右滚动的iscroll
                    page_flip = new iScroll('pagewrapper', {
                        bounce: false,
                        hScrollbar: false,
                        vScrollbar: false,
                        vScroll: false,
                        snap: true,//此处必须为true
                        momentum: false,
                        lockDirection: true,
                        fixedScrollbar: false,//只有按住屏幕的时候才能显示出滚动条
                        onScrollEnd: function () {
                            //如果滑动多个菜单回滚为+1或-1
                            if (this.currPageX - currentPageX > 1 || this.currPageX - currentPageX < -1) {
                                var w = $id('pagewrapper').offsetWidth;
                                currentPageX = this.x < (currentPageX * -w) ? currentPageX + 1 : currentPageX - 1;
                                this.scrollToPage(currentPageX);
                                return;
                            }
                            //此处利用this.currPagex 获取当前是在第几屏 . 从0开始:0,1,2,3,4.....
                            //active为处于当前某个栏目时导航的样式.
                            $s('#nav a.active').className = '';
                            $s('#nav li:nth-child(' + (this.currPageX + 1) + ') a').className = 'active';
                            //避免在首尾页面重复请求
                            if (currentPageX !== this.currPageX) {
                                //请求页面
                                _ajaxHTML(this.currPageX);
//                                menuPageNum[this.currPageX] = null;
                            }
                            //禁用最外层滚动放置同时滑动多个屏幕
                            if (this.currPageX !== 0 && this.x !== 0) {
                                mainScroll.disable();
                            } else {
                                mainScroll.enable();
                            }
                            //设置当前页能用禁用其他页
                            vertical_scroll[currentPageX].enable();
                            for (var i = 0; i < pages.length; i++) {
                                if (i !== currentPageX) {
                                    vertical_scroll[i].disable();
                                }
                            }
                            this.refresh();

                        }, onScrollStart: function () {
                            if (this.currPageX !== 0 && this.x !== 0) {
                                mainScroll.disable();
                            }
                        }
                    });
                    //此处的获取size函数不能缺少.除非你自定义css.
                    for (var a = 0; a < pages.length; a++) {
                        //利用数组来定义出上下滚动的iscroll
                        vertical_scroll[a] = new iScroll(pages[a], {
                            snap: true,
                            bounce: true,
                            hScrollbar: false,
                            vScrollbar: true,
                            hScroll: true,
                            fixedScrollbar: false,
                            lockDirection: true,
                            mouseWheel: true,
                            fadeScrollbar: true,
                            hideScrollbar: false,
                            onScrollEnd: function () {
                                page_flip.enable();
                                //这里可以设置那个模块可以分页
//                                if (currentPageX === 0) {
//                                    return;
//                                }
                                if(downfresh){
                                    console.log("refresh");
                                }
                                //请求分页数据
                                if (this.distX < 0) {
                                    page_flip.enable();
                                }
                                _ajaxPage(this.currPageY);
                                $(".top-btn").html("top");
//                                console.log(this.distX)
                            }, onScrollMove: function () {
                                console.log(this.y+"---"+this.dirY);
                                if (this.y > 0 && this.dirY === -1) {
                                    downfresh = true;
                                }else{
                                    downfresh = false;
                                }
                                //小于0是水平滑动等于0是垂直滑动
                                if (this.distX !== 0) {
                                    page_flip.enable();
                                } else {
                                    page_flip.disable();
                                }
                                $(".top-btn").html("<div class='t-page'>256</div><div class='line'></div><div class='t-page'>" + menuPageNum[currentPageX] + "</div>");
                            }
                        });
                    }
                    setSize();
                    //默认跳转到第二个菜单
                    mainScroll.scrollToPage(1, 0, 0);
                }
            }, setSize = function () {//重新计算宽度
                if (window.scrollY === 0) {
                    window.scrollY = 1;
                    p = setTimeout(setSize, 100);
                }
                else {
                    //清除
                    clearTimeout(p);
                    p = null;
                    //vsrollH 为屏幕高度- 头部高度，即为滚动区域高度
                    var vscrollH = window.innerHeight - $id('nav').offsetHeight - $s(".b-nav").offsetHeight;
                    if (iDevice) {
                        //高度设置。其实完全可以在css里设置height：100%。
                        $id('pagewrapper').style.height = vscrollH + 'px';
                    }
                    var e = $id('pagewrapper'), a = $id('pageflip'), b = e.offsetWidth;
                    //这里的6可以随便替换成你所要
                    //几个左右滚动页这里为几。
                    //宽度设置
                    //同样可以在css里设置
                    a.style.width = b * 5 + 'px';
                    for (var c = 0; c < pages.length; c++) {
                        pages[c].style.width = b + 'px';
//                        pages[0].style.width = "220px";
                        if (vertical_scroll[c]) {
                            //设置上下滚动的每个iscroll的高度
                            pages[c].style.height = vscrollH + 'px';
                            vertical_scroll[c].refresh();
                        }
                    }
                    page_flip.refresh();
                    mainScroll.refresh();
                }

            }, loaded = function () {//初始化load事件
                window.scrollTo(0, 1);
                t = setTimeout(initScroll, 100);
                window.removeEventListener('load', loaded, false);
            }, stopDefault = function (e) {
                e.preventDefault()
            }, delegate = function (obj, fun, callback) {
                var parent = $id(obj);
                parent.addEventListener(fun, callback, false);
            }, init = function () {
                window.addEventListener('DOMContentLoaded', loaded, false);
//                menuPageNum = [null, null, null, null, null];//默认为初始化
                menuPageNum = [1, 1, 1, 1, 1];//默认为初始化
            }, _ajaxHTML = function (index) {
                currentPageX = index;
                console.log("这里执行ajax请求切换页面..." + index);
//                var json = [{html: "<div>这是第一个content内容</div>"}, {html: "<div>这是第二个content内容</div>"}, {html: "<div>这是第三个content内容</div>"}, {html: "<div>这是第四个content内容</div>"}, {html: "<div>这是第五个content内容</div>"}]
//                pages[index].innerHTML = json[index].html + "change html content now page _" + index;
            }, _ajaxPage = function (index) {
                //请求响应页面计数
                var pageNum = menuPageNum[currentPageX];
                console.log("当前第 " + pageNum + " 页");
                if (pageNum !== 1) {
                    if (--pageNum > index) {
                        console.log("数据已存在不执行请求");
                        return;
                    }
                }
                menuPageNum[currentPageX]++;
                console.log("这里执行ajax请求分页..." + menuPageNum[currentPageX]);
                var html = "";
                for (var i = 0; i < 8; i++) {
                    html += "<li>菜单" + (currentPageX + 1) + "第" + (menuPageNum[currentPageX]) + "页</li>"
                }
                $(".scrollerwrapper").eq(currentPageX).children("ul").append(html);
                vertical_scroll[currentPageX].refresh();
            }, scrollTops = function () {
                vertical_scroll[currentPageX].scrollTo(0, 0);
            }

    //点击跳转到指定菜单
    $('#nav a').bind("click", function () {
        if (page_flip) {
            page_flip.scrollToPage(parseInt(this.rel) - 1, 0, 0);
        }
    });

    //点击展开左边菜单
    menuBtn.bind("click", function () {
        //设置最外层为可用
        if (mainScroll) {
            mainScroll.enable();
            mainScroll.scrollToPage(menuBtn.mark, 0, 0);
            mainScroll.refresh();
        }
    });
    init();

</script>
</body>
</html>